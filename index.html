<!DOCTYPE html>
<html>
  <head>
    <title>AR Debug Mode</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* Full screen loader */
      #loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      
      /* Visual Debug Log for Mobile */
      #debug-log {
        position: fixed; top: 0; left: 0; width: 100%; max-height: 200px;
        background: rgba(255, 0, 0, 0.5); color: white; 
        z-index: 10000; pointer-events: none; overflow-y: auto;
        font-size: 12px; padding: 5px;
      }

      button {
        padding: 15px 30px; font-size: 18px; cursor: pointer;
        background: #ffd166; border: none; border-radius: 8px; margin-top: 20px;
      }
    </style>
  </head>

  <body style="margin : 0px; overflow: hidden;">

    <div id="debug-log">Status: Initializing...<br></div>

    <div id="loader">
      <h2 id="status-text">Requesting Camera...</h2>
      <p>If this takes more than 5 seconds, check the Red Log above.</p>
      <button id="force-start" style="display:none" onclick="hideLoader()">Force Enter</button>
    </div>

    <a-scene 
      embedded 
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;">

      <a-marker preset="hiro">
         <a-box position="0 0.5 0" material="color: yellow; opacity: 0.8;"></a-box>
         <a-text value="IT WORKS!" position="0 1.2 0" align="center" color="red" scale="2 2 2"></a-text>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const logBox = document.getElementById('debug-log');
      const loader = document.getElementById('loader');
      const forceBtn = document.getElementById('force-start');
      const statusText = document.getElementById('status-text');

      function log(msg) {
        logBox.innerHTML += msg + "<br>";
        console.log(msg);
      }

      function hideLoader() {
        loader.style.display = 'none';
        log("Loader hidden by user/script.");
      }

      // 1. Check if we are on HTTPS
      if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        log("❌ CRITICAL ERROR: You are not using HTTPS. Camera will be blocked.");
        statusText.innerText = "ERROR: Site must be HTTPS";
        alert("AR requires HTTPS! The camera will not open.");
      } else {
        log("✅ HTTPS/Localhost detected.");
      }

      // 2. Listen for Scene Loaded
      const scene = document.querySelector('a-scene');
      
      scene.addEventListener('loaded', () => {
        log("✅ A-Frame Scene Loaded!");
        statusText.innerText = "Scene Ready!";
        // Show button to let user enter manually if they want
        forceBtn.style.display = 'block'; 
        // Auto-hide after 1 second
        setTimeout(() => {
             hideLoader();
        }, 1000);
      });

      scene.addEventListener('camera-error', (e) => {
        log("❌ Camera Error: " + JSON.stringify(e));
        statusText.innerText = "Camera Access Denied";
      });

      // 3. Fallback Timeout
      setTimeout(() => {
        if (loader.style.display !== 'none') {
          log("⚠️ Timeout: Scene took too long. Showing Force Button.");
          forceBtn.style.display = 'block';
        }
      }, 5000);
    </script>
  </body>
</html>