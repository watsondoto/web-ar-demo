<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Markerless WebAR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar-nft.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #start-button {
        padding: 20px 40px;
        font-size: 18px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }
      #instructions {
        color: white;
        text-align: center;
        padding: 20px;
        max-width: 80%;
      }
      #info {
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 9998;
        font-size: 14px;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="overlay">
      <div id="instructions">
        <h2>ðŸŽ­ AR Surface Tracking</h2>
        <p><strong>Important:</strong> Move your phone slowly around to scan surfaces. When detected, tap to place the dancing character!</p>
        <p style="font-size: 12px;">Works best in well-lit areas with textured surfaces (not plain white paper)</p>
      </div>
      <button id="start-button">Start AR</button>
    </div>

    <div id="info" class="hidden">
      <strong>ðŸ“± Move phone slowly</strong> to detect surfaces, then tap to place
    </div>

    <a-scene
      id="scene"
      class="hidden"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      gesture-detector
      renderer="logarithmicDepthBuffer: true; precision: medium;">
      
      <!-- Character container that will be placed -->
      <a-entity id="characterContainer" visible="false">
        <!-- Body -->
        <a-cylinder 
          position="0 0.5 0" 
          radius="0.3" 
          height="1" 
          color="#4CAF50"
          id="body">
        </a-cylinder>
        
        <!-- Head -->
        <a-sphere 
          position="0 1.3 0" 
          radius="0.3" 
          color="#FFD700"
          id="head">
        </a-sphere>
        
        <!-- Eyes -->
        <a-sphere 
          position="-0.12 1.35 0.25" 
          radius="0.08" 
          color="#000000">
        </a-sphere>
        <a-sphere 
          position="0.12 1.35 0.25" 
          radius="0.08" 
          color="#000000">
        </a-sphere>
        
        <!-- Left Arm -->
        <a-cylinder 
          position="-0.5 0.5 0" 
          radius="0.1" 
          height="0.8" 
          color="#4CAF50"
          rotation="0 0 30"
          id="leftArm">
        </a-cylinder>
        
        <!-- Right Arm -->
        <a-cylinder 
          position="0.5 0.5 0" 
          radius="0.1" 
          height="0.8" 
          color="#4CAF50"
          rotation="0 0 -30"
          id="rightArm">
        </a-cylinder>
        
        <!-- Left Leg -->
        <a-cylinder 
          position="-0.2 -0.4 0" 
          radius="0.12" 
          height="0.8" 
          color="#2196F3"
          id="leftLeg">
        </a-cylinder>
        
        <!-- Right Leg -->
        <a-cylinder 
          position="0.2 -0.4 0" 
          radius="0.12" 
          height="0.8" 
          color="#2196F3"
          id="rightLeg">
        </a-cylinder>

        <!-- Particles -->
        <a-entity
          id="particles"
          particle-system="preset: dust; particleCount: 200; size: 0.03; color: #FFD700,#FF6B6B; maxAge: 2; velocityValue: 0 2 0; velocitySpread: 2 0 2;">
        </a-entity>
      </a-entity>

      <!-- Camera -->
      <a-camera
        id="camera"
        position="0 0 0"
        look-controls="enabled: false"
        cursor="fuse: false; rayOrigin: mouse;"
        raycaster="far: 10000; objects: .clickable">
      </a-camera>
    </a-scene>

    <!-- Load particle system -->
    <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component/dist/aframe-particle-system-component.min.js"></script>

    <script>
      let characterPlaced = false;
      let startTime = Date.now();

      // Gesture detector component
      AFRAME.registerComponent('gesture-detector', {
        schema: {
          element: { default: '' }
        },
        init: function() {
          this.handleTap = this.handleTap.bind(this);
        },
        play: function() {
          window.addEventListener('click', this.handleTap);
          window.addEventListener('touchstart', this.handleTap);
        },
        pause: function() {
          window.removeEventListener('click', this.handleTap);
          window.removeEventListener('touchstart', this.handleTap);
        },
        handleTap: function(evt) {
          if (evt.touches) {
            evt.preventDefault();
          }
          
          const camera = document.querySelector('#camera');
          const character = document.querySelector('#characterContainer');
          const info = document.getElementById('info');
          
          if (camera && character) {
            // Place character 3 meters in front of camera
            const cameraPos = camera.object3D.position;
            const cameraRot = camera.object3D.rotation;
            
            // Calculate position in front of camera
            const distance = 3;
            const x = cameraPos.x - Math.sin(cameraRot.y) * distance;
            const y = cameraPos.y - 0.5; // Slightly below camera
            const z = cameraPos.z - Math.cos(cameraRot.y) * distance;
            
            character.setAttribute('position', `${x} ${y} ${z}`);
            character.setAttribute('visible', 'true');
            
            if (!characterPlaced) {
              characterPlaced = true;
              info.innerHTML = '<strong>ðŸŽ‰ Character placed!</strong> Move your phone to see it stay in place. Tap to relocate.';
              startTime = Date.now();
            }
          }
        }
      });

      // Dancing animation component
      AFRAME.registerComponent('dance-animation', {
        init: function() {
          this.leftArm = document.querySelector('#leftArm');
          this.rightArm = document.querySelector('#rightArm');
          this.leftLeg = document.querySelector('#leftLeg');
          this.rightLeg = document.querySelector('#rightLeg');
          this.body = document.querySelector('#body');
          this.head = document.querySelector('#head');
          this.container = document.querySelector('#characterContainer');
        },
        tick: function(time) {
          if (!characterPlaced || !this.container) return;
          
          const t = (Date.now() - startTime) / 1000;
          
          // Body bounce
          const baseY = parseFloat(this.container.getAttribute('position').y.split(' ')[1] || 0);
          const bounceY = baseY + Math.abs(Math.sin(t * 4)) * 0.1;
          const currentPos = this.container.getAttribute('position');
          this.container.setAttribute('position', `${currentPos.x} ${bounceY} ${currentPos.z}`);
          
          // Rotation dance
          this.container.object3D.rotation.y = Math.sin(t * 2) * 0.3;
          
          // Arms swinging
          if (this.leftArm) {
            this.leftArm.object3D.rotation.z = (30 + Math.sin(t * 3) * 45) * (Math.PI / 180);
          }
          if (this.rightArm) {
            this.rightArm.object3D.rotation.z = (-30 - Math.sin(t * 3) * 45) * (Math.PI / 180);
          }
          
          // Legs moving
          if (this.leftLeg) {
            this.leftLeg.object3D.rotation.x = Math.sin(t * 3) * 0.3;
          }
          if (this.rightLeg) {
            this.rightLeg.object3D.rotation.x = -Math.sin(t * 3) * 0.3;
          }
          
          // Head bobbing
          if (this.head) {
            this.head.object3D.rotation.z = Math.sin(t * 2) * 0.2;
          }
        }
      });

      // Start button
      document.getElementById('start-button').addEventListener('click', function() {
        const overlay = document.getElementById('overlay');
        const scene = document.getElementById('scene');
        const info = document.getElementById('info');
        
        overlay.classList.add('hidden');
        scene.classList.remove('hidden');
        info.classList.remove('hidden');
        
        // Add animation component
        setTimeout(() => {
          const character = document.querySelector('#characterContainer');
          if (character) {
            character.setAttribute('dance-animation', '');
          }
        }, 1000);
      });
    </script>
  </body>
</html>